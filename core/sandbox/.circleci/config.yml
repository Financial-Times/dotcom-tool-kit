# CONFIG GENERATED BY DOTCOM-TOOL-KIT, DO NOT EDIT BY HAND
version: 2.1
orbs:
  tool-kit: financial-times/dotcom-tool-kit@dev:alpha
jobs:
  checkout:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - tool-kit/persist-workspace:
          path: .
workflows:
  version: 2
  tool-kit:
    jobs:
      - checkout:
          filters:
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
      - waiting-for-approval:
          type: approval
          filters:
            branches:
              only: /(^renovate-.*|^nori/.*)/
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
      - tool-kit/setup:
          requires:
            - checkout
            - waiting-for-approval
          filters:
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
      - tool-kit/build:
          requires:
            - tool-kit/setup
          filters:
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
      - tool-kit/test:
          requires:
            - tool-kit/build
          filters:
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
      - tool-kit/heroku-provision:
          requires:
            - tool-kit/setup
          filters:
            branches:
              ignore: /(^renovate-.*|^nori/.*|^main)/
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
      - tool-kit/heroku-staging:
          requires:
            - tool-kit/setup
          filters:
            branches:
              only: main
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
      - tool-kit/e2e-test-review:
          requires:
            - tool-kit/heroku-provision
          filters:
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
      - tool-kit/e2e-test-staging:
          requires:
            - tool-kit/heroku-staging
          filters:
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
      - tool-kit/heroku-promote:
          requires:
            - tool-kit/test
            - tool-kit/e2e-test-staging
          filters:
            branches:
              only: main
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
      - tool-kit/publish:
          context: npm-publish-token
          requires:
            - tool-kit/test
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v\d+\.\d+\.\d+(-.+)?/
  nightly:
    triggers:
      - schedule:
          cron: 0 0 * * *
          filters:
            branches:
              only: main
    jobs:
      - tool-kit/setup
      - tool-kit/build:
          requires:
            - tool-kit/setup
      - tool-kit/test:
          requires:
            - tool-kit/build
