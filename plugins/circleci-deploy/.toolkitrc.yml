plugins:
  - '@dotcom-tool-kit/circleci'

options:
  hooks:
    - CircleCi:
        custom:
          orbs:
            change-api: financial-times/change-api@1.0.9
            cloudsmith-oidc: ft-circleci-orbs/cloudsmith-oidc@1.0
            aws-cli: circleci/aws-cli@3.1.4
            serverless-framework: circleci/serverless-framework@2.0.2
        jobs:
          - name: deploy-review
            command: 'deploy:review'
          - name: deploy-staging
            command: 'deploy:staging'
          - name: e2e-test-review
            command: 'test:review'
          - name: e2e-test-staging
            command: 'test:staging'
          - name: deploy-production
            command: 'deploy:production'
            workspace:
              persist: false
            steps:
              pre:
                - setup_remote_docker:
                    docker_layer_caching: true
              post:
                - change-api/change-log:
                    environment: production
                    system-code: << parameters.system-code >>

          - name: teardown-review
            command: 'teardown:review'
            workspace:
              persist: false
            custom:
              environment:
                CIRCLE_BRANCH: << pipeline.event.github.pull_request.head.ref >>
        workflows:
          - name: 'tool-kit'
            jobs:
              - name: 'deploy-review'
                requires:
                  - 'build'
                splitIntoMatrix: false
                runOnRelease: false
                custom:
                  filters:
                    branches:
                      ignore: main
                  !toolkit/if-defined '@dotcom-tool-kit/serverless.awsAccountId':
                    aws-account-id: !toolkit/option '@dotcom-tool-kit/serverless.awsAccountId'
                    system-code: !toolkit/option '@dotcom-tool-kit/serverless.systemCode'
              - name: 'deploy-staging'
                requires:
                  - 'build'
                splitIntoMatrix: false
                runOnRelease: true
                custom:
                  filters:
                    branches:
                      only: main
              - name: 'e2e-test-review'
                requires:
                  - 'deploy-review'
                splitIntoMatrix: false
                runOnRelease: false
                custom:
                  !toolkit/if-defined '@dotcom-tool-kit/circleci.cypressImage':
                    executor: cypress
                  !toolkit/if-defined '@dotcom-tool-kit/serverless.awsAccountId':
                    aws-account-id: !toolkit/option '@dotcom-tool-kit/serverless.awsAccountId'
                    system-code: !toolkit/option '@dotcom-tool-kit/serverless.systemCode'
              - name: 'e2e-test-staging'
                splitIntoMatrix: false
                runOnRelease: true
                requires:
                  - 'deploy-staging'
                custom:
                  !toolkit/if-defined '@dotcom-tool-kit/circleci.cypressImage':
                    executor: cypress
              - name: 'deploy-production'
                requires:
                  - 'test'
                  - 'e2e-test-staging'
                splitIntoMatrix: false
                runOnRelease: true
                custom:
                  filters:
                    branches:
                      only: main
                  !toolkit/if-defined '@dotcom-tool-kit/serverless.awsAccountId':
                    aws-account-id: !toolkit/option '@dotcom-tool-kit/serverless.awsAccountId'
                    system-code: !toolkit/option '@dotcom-tool-kit/serverless.systemCode'
          - name: 'nightly'
            jobs:
              - name: 'deploy-review'
                requires:
                  - 'build'
                splitIntoMatrix: false
                runOnRelease: false
                custom:
                  filters:
                    branches:
                      ignore: main
                  !toolkit/if-defined '@dotcom-tool-kit/serverless.awsAccountId':
                    aws-account-id: !toolkit/option '@dotcom-tool-kit/serverless.awsAccountId'
                    system-code: !toolkit/option '@dotcom-tool-kit/serverless.systemCode'
          - name: 'pr-close'
            jobs:
              - name: 'teardown-review'
                requires:
                  - 'setup'
                splitIntoMatrix: false
                runOnRelease: false
        !toolkit/if-defined '@dotcom-tool-kit/circleci.cypressImage':
          executors:
            - name: cypress
              image: !toolkit/option '@dotcom-tool-kit/circleci.cypressImage'

version: 2
