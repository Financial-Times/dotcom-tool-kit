# `circleci-npm` Tool Kit plugin

This plugin is for managing the `publish:tag` hook that is run from circleci to publish the built package to the npm registry.

## Installation

Install `@dotcom-tool-kit/circleci-npm` as a `devDependency` in your app:

```sh
npm install --save-dev @dotcom-tool-kit/circleci-npm
```

Add the plugin to your [Tool Kit configuration](https://github.com/financial-times/dotcom-tool-kit/blob/main/readme.md#configuration):

```yaml
plugins:
	- '@dotcom-tool-kit/circleci-npm'
```

And install this plugin's hooks:

```sh
npx dotcom-tool-kit --install
```

If you have the automated comment `# CONFIG GENERATED BY DOTCOM-TOOL-KIT, DO NOT EDIT BY HAND\n` in your `config.yml`, this will add the tool-kit/publish job to your `config.yml`. Furthermore, this will add the tags filter to the rest of the tool-kit jobs in your workflow in `config.yml`, as CircleCI will only run the jobs if the rest of the jobs have the tags filter. 

If you don't have the automated comment in your `config.yml` and therefore choose to add the tool-kit/publish job manually, (1) copy and paste the below code snippet and (2) add the tags filter to the rest of the tool-kit jobs (you may refer to dotcom-tool-kit/core/sandbox/.circleci/config.yml as an example for this)

```yaml
	- tool-kit/publish:
		context: npm-publish-token
		requires:
		- tool-kit/test
		filters:
		branches:
			ignore: /.*/
		tags:
			only: /^v\d+\.\d+\.\d+(-.+)?/
```

The tool-kit/publish job is triggered in your circleci pipeline once you do a release with a tag matching the semver format, e.g. `v1.6.0-beta.1`, `v1.6.0`. If your tag is a beta version, i.e. `v1.6.0-beta.1`, then the publish job will tag your build as a prerelease version. But if your tag is a release version, i.e. `v1.6.0`, then the publish job will tag your build as the latest version.

## Hooks

| Event | Description | Installed to...|
|-|-|-|
| `publish:tag` | Publishes the built package to the npm registry | `publish` job in `.circle/config.yml`  |

