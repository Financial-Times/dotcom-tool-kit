installs:
  CircleCi:
    entryPoint: './lib/circleci-config'
    managesFiles:
      - '.circleci/config.yml'

optionsSchema: './lib/schemas/plugin'

options:
  hooks:
    - CircleCi:
        custom:
          orbs:
            node: circleci/node@5.0.2
        jobs:
          - name: checkout
            steps:
              custom:
                - checkout
            custom:
              executor: base
            workspace:
              persist: ['.']
            splitIntoMatrix: false
          - name: setup
            steps:
              custom:
                - node/install-packages
            workspace:
              persist: ['.']
          - name: build
            command: 'build:ci'
            workspace:
              persist: ['.']
          - name: test
            command: 'test:ci'
        workflows:
          - name: 'tool-kit'
            custom:
              when: pipeline.trigger_source != "scheduled_pipeline"
            jobs:
              - name: checkout
              - name: setup
                requires:
                  - 'checkout'
              - name: build
                requires:
                  - 'setup'
              - name: test
                requires:
                  - 'build'
            runOnRelease: true
          - name: 'nightly'
            custom:
              when: |
                pipeline.trigger_source == "scheduled_pipeline" and
                pipeline.schedule.name == "nightly"
            jobs:
              - name: checkout
              - name: setup
                requires:
                  - 'checkout'
              - name: build
                requires:
                  - 'setup'
              - name: test
                requires:
                  - 'build'
          - name: 'pr-close'
            custom:
              when: |
                pipeline.trigger_source != "scheduled_pipeline" and
                (pipeline.event.name == "pull_request" and pipeline.event.action == "closed")
            jobs:
              - name: 'checkout'
              - name: 'setup'
                requires:
                  - 'checkout'


init:
  - './lib/init-env-vars'

version: 2
