installs:
  CircleCi:
    entryPoint: './lib/circleci-config'
    managesFiles:
      - '.circleci/config.yml'

options:
  hooks:
    - CircleCi:
        jobs:
          - name: checkout
            steps:
              pre:
                - checkout
            workspace:
              attach: false
              persist: true
          - name: setup
            steps:
              pre:
                - node/install-packages
          - name: build
            command: 'build:ci'
          - name: test
            command: 'test:ci'
        workflows:
          - name: 'tool-kit'
            jobs:
              - name: 'checkout'
              - name: 'setup'
                requires:
                  - 'checkout'
              - name: build
                requires:
                  - 'setup'
              - name: test
                requires:
                  - 'build'
            custom:
              when:
                not:
                  equal: ['scheduled_pipeline', '<< pipeline.trigger_source >>']
            runOnRelease: true
          - name: 'nightly'
            jobs:
              - name: build
                requires:
                  - 'setup'
              - name: test
                requires:
                  - 'build'
            custom:
              when:
                and:
                  - equal: ['scheduled_pipeline', '<< pipeline.trigger_source >>']
                  - equal: ['nightly', '<< pipeline.schedule.name >>']

init:
  - './lib/init-env-vars'

version: 2
