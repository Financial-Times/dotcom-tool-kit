installs:
  CircleCi:
    entryPoint: './lib/circleci-config'
    managesFiles:
      - '.circleci/config.yml'

optionsSchema: './lib/schemas/plugin'

options:
  hooks:
    - CircleCi:
        jobs:
          - name: build
            command: 'build:ci'
          - name: test
            command: 'test:ci'
        workflows:
          - name: 'tool-kit'
            custom:
              when: |
                pipeline.trigger_source != "scheduled_pipeline" and
                (pipeline.event.name == "push" or (pipeline.event.name == "pull_request"
                and pipeline.event.action != "closed"))
            jobs:
              - name: build
                requires:
                  - 'setup'
              - name: test
                requires:
                  - 'build'
            runOnRelease: true
          - name: 'nightly'
            jobs:
              - name: build
                requires:
                  - 'setup'
              - name: test
                requires:
                  - 'build'
          - name: 'pr-close'
            custom:
              when: |
                pipeline.trigger_source != "scheduled_pipeline" and
                (pipeline.event.name == "pull_request" and pipeline.event.action == "closed")
            jobs:
              - name: 'checkout'
              - name: 'setup'
                requires:
                  - 'checkout'


init:
  - './lib/init-env-vars'

version: 2
